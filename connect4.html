<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4 - Gold BBs Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-container, .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 600px;
        }
        
        .auth-container {
            max-width: 400px;
        }
        
        .hidden {
            display: none !important;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        input {
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin: 10px 0;
        }
        
        .success-message {
            color: #27ae60;
            font-size: 0.9em;
            margin: 10px 0;
        }
        
        .user-info {
            background: rgba(103, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .gold-rims {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            font-size: 2.5em;
        }
        
        .rim {
            transition: all 0.3s ease;
        }
        
        .rim.earned {
            filter: drop-shadow(0 0 10px gold);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { filter: drop-shadow(0 0 5px gold) brightness(1); }
            50% { filter: drop-shadow(0 0 15px gold) brightness(1.3); }
        }
        
        .secrets-unlocked {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .status {
            font-size: 1.3em;
            margin: 20px 0;
            font-weight: bold;
            min-height: 40px;
        }
        
        .player1-turn { color: #e74c3c; }
        .player2-turn { color: #3498db; }
        .winner { color: #27ae60; }
        .draw { color: #7f8c8d; }
        
        #board {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 15px;
            display: inline-block;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 20px 0;
        }
        
        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .row:last-child {
            margin-bottom: 0;
        }
        
        .cell {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .cell:hover:not(.filled) {
            background: #ecf0f1;
            transform: scale(1.05);
        }
        
        .cell.filled {
            cursor: default;
        }
        
        .cell.player1 {
            background: #e74c3c;
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.4);
        }
        
        .cell.player2 {
            background: #3498db;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
        }
        
        .cell.winning {
            animation: pulse 0.5s ease-in-out 3;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.8);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
        }
        
        .reset-btn {
            background: #27ae60;
        }
        
        .reset-btn:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .home-btn {
            background: #3498db;
        }
        
        .home-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .red { color: #e74c3c; }
        .blue { color: #3498db; }
        .gray { color: #7f8c8d; }
        
        @media (max-width: 600px) {
            .cell {
                width: 45px;
                height: 45px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .status {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <h1>üèÜ Gold BBs Challenge üèÜ</h1>
        <h2>Connect 4 vs J4RV1S</h2>
        <p style="color: #666; margin: 20px 0;">Beat J4RV1S 4 times to collect all 4 Gold BBs Tire Rims and unlock ALL the secrets!</p>
        
        <div id="loginForm">
            <div class="auth-form">
                <input type="text" id="loginUsername" placeholder="Username" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button class="reset-btn" onclick="login()">üîë Login</button>
                <div class="error-message hidden" id="loginError"></div>
            </div>
            <p style="color: #666;">Don't have an account? <a href="#" onclick="showSignup(); return false;" style="color: #667eea;">Sign up</a></p>
        </div>
        
        <div id="signupForm" class="hidden">
            <div class="auth-form">
                <input type="text" id="signupUsername" placeholder="Username" required>
                <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" required>
                <input type="password" id="signupPasswordConfirm" placeholder="Confirm Password" required>
                <button class="reset-btn" onclick="signup()">üéÆ Sign Up</button>
                <div class="error-message hidden" id="signupError"></div>
                <div class="success-message hidden" id="signupSuccess"></div>
            </div>
            <p style="color: #666;">Already have an account? <a href="#" onclick="showLogin(); return false;" style="color: #667eea;">Login</a></p>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container hidden" id="gameContainer">
        <div class="user-info">
            <h3>Welcome, <span id="displayUsername"></span>! ÔøΩ</h3>
            <button class="home-btn" onclick="logout()" style="margin: 10px 5px;">üö™ Logout</button>
            <button class="home-btn" onclick="window.location.href='/'" style="margin: 10px 5px;">üè† Home</button>
        </div>
        
        <div class="gold-rims" id="goldRims">
            <span class="rim" data-rim="1">üîò</span>
            <span class="rim" data-rim="2">üîò</span>
            <span class="rim" data-rim="3">üîò</span>
            <span class="rim" data-rim="4">üîò</span>
        </div>
        
        <div id="secretsMessage" class="secrets-unlocked hidden">
            <h2>üéâ ALL SECRETS UNLOCKED! üéâ</h2>
            <p>You've collected all 4 Gold BBs Tire Rims!</p>
            <p>Check your email for the secret location...</p>
        </div>
        
        <h1>üî¥ Connect 4 üîµ</h1>
        <div class="status player1-turn" id="status">Your Turn</div>
        
        <div id="board"></div>
        
        <div class="controls">
            <button class="reset-btn" onclick="resetGame()">üîÑ New Game</button>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Consecutive Wins</div>
                <div class="stat-value red" id="consecutiveWins">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">J4RV1S Wins</div>
                <div class="stat-value blue" id="blueWins">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Draws</div>
                <div class="stat-value gray" id="draws">0</div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentUser = null;
        let userData = null;

        // Game variables
        const ROWS = 6;
        const COLS = 7;
        let board = [];
        let currentPlayer = 1;
        let gameOver = false;

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                showGame();
            } else {
                currentUser = null;
                userData = null;
                showAuth();
            }
        });

        async function loadUserData() {
            const userRef = ref(database, 'users/' + currentUser.uid);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                userData = snapshot.val();
            } else {
                // Initialize new user data
                userData = {
                    username: currentUser.email.split('@')[0],
                    goldRims: 0,
                    consecutiveWins: 0,
                    totalWins: 0,
                    secretsUnlocked: false
                };
                await set(userRef, userData);
            }
            
            updateUI();
        }

        async function updateUserData() {
            if (!currentUser) return;
            const userRef = ref(database, 'users/' + currentUser.uid);
            await update(userRef, userData);
            updateUI();
        }

        window.showLogin = function() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        };

        window.showSignup = function() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        };

        window.signup = async function() {
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            const errorEl = document.getElementById('signupError');
            const successEl = document.getElementById('signupSuccess');
            
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');
            
            if (!username || !password) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }
            
            try {
                const email = username + '@goldbbschallenge.local';
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                successEl.textContent = 'Account created! Logging you in...';
                successEl.classList.remove('hidden');
            } catch (error) {
                errorEl.textContent = error.message.includes('already-in-use') ? 'Username already taken' : error.message;
                errorEl.classList.remove('hidden');
            }
        };

        window.login = async function() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            errorEl.classList.add('hidden');
            
            if (!username || !password) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.classList.remove('hidden');
                return;
            }
            
            try {
                const email = username + '@goldbbschallenge.local';
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = 'Invalid username or password';
                errorEl.classList.remove('hidden');
            }
        };

        window.logout = async function() {
            await signOut(auth);
        };

        function showAuth() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('gameContainer').classList.add('hidden');
        }

        function showGame() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            document.getElementById('displayUsername').textContent = userData.username;
            initBoard();
        }

        function updateUI() {
            if (!userData) return;
            
            // Update gold rims display
            for (let i = 1; i <= 4; i++) {
                const rimEl = document.querySelector(`[data-rim="${i}"]`);
                if (i <= userData.goldRims) {
                    rimEl.textContent = 'üèÜ';
                    rimEl.classList.add('earned');
                } else {
                    rimEl.textContent = 'üîò';
                    rimEl.classList.remove('earned');
                }
            }
            
            // Update stats
            document.getElementById('consecutiveWins').textContent = userData.consecutiveWins;
            
            // Show secrets unlocked message
            if (userData.secretsUnlocked) {
                document.getElementById('secretsMessage').classList.remove('hidden');
            } else {
                document.getElementById('secretsMessage').classList.add('hidden');
            }
        }
        
        function initBoard() {
            board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            currentPlayer = 1;
            gameOver = false;
            
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            
            for (let row = 0; row < ROWS; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                
                for (let col = 0; col < COLS; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.onclick = () => dropPiece(col);
                    rowDiv.appendChild(cell);
                }
                
                boardElement.appendChild(rowDiv);
            }
            
            updateStatus();
            updateStats();
        }
        
        async function dropPiece(col) {
            if (gameOver || currentPlayer === 2) return; // Prevent player moves during AI turn
            
            // Find the lowest empty row in this column
            let row = -1;
            for (let r = ROWS - 1; r >= 0; r--) {
                if (board[r][col] === 0) {
                    row = r;
                    break;
                }
            }
            
            if (row === -1) return; // Column is full
            
            // Place the piece
            board[row][col] = currentPlayer;
            
            // Update the visual
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            cell.classList.add('filled', currentPlayer === 1 ? 'player1' : 'player2');
            
            // Check for win
            if (checkWin(row, col)) {
                gameOver = true;
                if (currentPlayer === 1) {
                    // Player wins!
                    userData.consecutiveWins++;
                    userData.totalWins++;
                    
                    // Award gold rim for each win
                    if (userData.goldRims < 4) {
                        userData.goldRims++;
                        document.getElementById('status').textContent = `You Win! üéâ Gold BBs Tire Rim #${userData.goldRims} Earned! ÔøΩ`;
                    } else {
                        document.getElementById('status').textContent = `You Win! üéâ`;
                    }
                    
                    // Check if all 4 rims collected
                    if (userData.goldRims >= 4 && !userData.secretsUnlocked) {
                        userData.secretsUnlocked = true;
                        setTimeout(() => {
                            alert('üéâ CONGRATULATIONS! üéâ\n\nYou\'ve collected all 4 Gold BBs Tire Rims!\n\nALL SECRETS HAVE BEEN UNLOCKED!\n\nCheck the game screen for your reward...');
                        }, 500);
                    }
                    
                    await updateUserData();
                } else {
                    // J4RV1S wins - reset consecutive wins
                    userData.consecutiveWins = 0;
                    await updateUserData();
                    document.getElementById('status').textContent = 'J4RV1S Wins! üéâ';
                }
                document.getElementById('status').className = 'status winner';
                return;
            }
            
            // Check for draw
            if (checkDraw()) {
                gameOver = true;
                userData.consecutiveWins = 0;
                await updateUserData();
                document.getElementById('status').textContent = "It's a Draw! ü§ù";
                document.getElementById('status').className = 'status draw';
                return;
            }
            
            // Switch player
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateStatus();
            
            // AI's turn
            if (currentPlayer === 2 && !gameOver) {
                setTimeout(() => aiMove(), 500);
            }
        }
        
        async function aiMove() {
            if (gameOver) return;
            
            // AI strategy: prioritize winning, then blocking, then center, then random
            let bestCol = -1;
            
            // 1. Check if AI can win in next move
            bestCol = findWinningMove(2);
            
            // 2. Check if need to block player from winning
            if (bestCol === -1) {
                bestCol = findWinningMove(1);
            }
            
            // 3. Try to play in center columns (better strategic position)
            if (bestCol === -1) {
                const centerCols = [3, 2, 4, 1, 5, 0, 6];
                for (let col of centerCols) {
                    if (isValidMove(col)) {
                        bestCol = col;
                        break;
                    }
                }
            }
            
            // 4. Fallback to random valid move
            if (bestCol === -1) {
                const validCols = [];
                for (let col = 0; col < COLS; col++) {
                    if (isValidMove(col)) validCols.push(col);
                }
                if (validCols.length > 0) {
                    bestCol = validCols[Math.floor(Math.random() * validCols.length)];
                }
            }
            
            if (bestCol !== -1) {
                // Find row for this column
                let row = -1;
                for (let r = ROWS - 1; r >= 0; r--) {
                    if (board[r][bestCol] === 0) {
                        row = r;
                        break;
                    }
                }
                
                if (row !== -1) {
                    // Place AI piece
                    board[row][bestCol] = 2;
                    const cell = document.querySelector(`[data-row="${row}"][data-col="${bestCol}"]`);
                    cell.classList.add('filled', 'player2');
                    
                    // Check for AI win
                    if (checkWin(row, bestCol)) {
                        gameOver = true;
                        userData.consecutiveWins = 0;
                        await updateUserData();
                        document.getElementById('status').textContent = 'J4RV1S Wins! üéâ';
                        document.getElementById('status').className = 'status winner';
                        return;
                    }
                    
                    // Check for draw
                    if (checkDraw()) {
                        gameOver = true;
                        userData.consecutiveWins = 0;
                        await updateUserData();
                        document.getElementById('status').textContent = "It's a Draw! ü§ù";
                        document.getElementById('status').className = 'status draw';
                        return;
                    }
                    
                    // Back to player
                    currentPlayer = 1;
                    updateStatus();
                }
            }
        }
        
        function findWinningMove(player) {
            // Try each column to see if it results in a win
            for (let col = 0; col < COLS; col++) {
                if (!isValidMove(col)) continue;
                
                // Find row
                let row = -1;
                for (let r = ROWS - 1; r >= 0; r--) {
                    if (board[r][col] === 0) {
                        row = r;
                        break;
                    }
                }
                
                if (row !== -1) {
                    // Simulate move
                    board[row][col] = player;
                    const wins = checkWin(row, col);
                    board[row][col] = 0; // Undo
                    
                    if (wins) return col;
                }
            }
            return -1;
        }
        
        function isValidMove(col) {
            return board[0][col] === 0;
        }
        
        function checkWin(row, col) {
            const player = board[row][col];
            const directions = [
                [[0, 1], [0, -1]],   // Horizontal
                [[1, 0], [-1, 0]],   // Vertical
                [[1, 1], [-1, -1]],  // Diagonal \
                [[1, -1], [-1, 1]]   // Diagonal /
            ];
            
            for (let [dir1, dir2] of directions) {
                let count = 1;
                const winningCells = [[row, col]];
                
                // Check in first direction
                for (let [dr, dc] of [dir1]) {
                    let r = row + dr;
                    let c = col + dc;
                    while (r >= 0 && r < ROWS && c >= 0 && c < COLS && board[r][c] === player) {
                        count++;
                        winningCells.push([r, c]);
                        r += dr;
                        c += dc;
                    }
                }
                
                // Check in opposite direction
                for (let [dr, dc] of [dir2]) {
                    let r = row + dr;
                    let c = col + dc;
                    while (r >= 0 && r < ROWS && c >= 0 && c < COLS && board[r][c] === player) {
                        count++;
                        winningCells.push([r, c]);
                        r += dr;
                        c += dc;
                    }
                }
                
                if (count >= 4) {
                    // Highlight winning cells
                    winningCells.forEach(([r, c]) => {
                        const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                        cell.classList.add('winning');
                    });
                    return true;
                }
            }
            
            return false;
        }
        
        function checkDraw() {
            return board[0].every(cell => cell !== 0);
        }
        
        function updateStatus() {
            const status = document.getElementById('status');
            if (currentPlayer === 1) {
                status.textContent = "Your Turn üî¥";
                status.className = 'status player1-turn';
            } else {
                status.textContent = "J4RV1S is thinking... üîµ";
                status.className = 'status player2-turn';
            }
        }

        window.resetGame = function() {
            initBoard();
        };
    </script>
</body>
</html>
